<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streamlit Transformers.js Component</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #0e1117;
      color: #00ff00;
      margin: 0;
      padding: 15px;
      overflow: hidden;
    }
    
    #container {
      max-width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    #log {
      background: #1a1d24;
      border: 1px solid #00ff00;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.4;
      overflow-y: auto;
      flex: 1;
      max-height: 200px;
    }
    
    #result {
      background: #1a1d24;
      border: 1px solid #00ff00;
      border-radius: 4px;
      padding: 10px;
      white-space: pre-wrap;
      font-size: 12px;
      overflow-y: auto;
      flex: 2;
    }
    
    .log-entry {
      margin: 2px 0;
    }
    
    .log-info { color: #00ff00; }
    .log-progress { color: #00bfff; }
    .log-success { color: #00ff7f; }
    .log-error { color: #ff4444; }
    
    .status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .status-loading { background: #00bfff; color: #000; }
    .status-success { background: #00ff7f; color: #000; }
    .status-error { background: #ff4444; color: #fff; }
  </style>
</head>
<body>
  <div id="container">
    <div id="log">
      <div class="log-entry log-info">ðŸš€ Component initialized...</div>
    </div>
    <pre id="result"></pre>
  </div>

  <!-- Local bundled transformers.js -->
  <script src="transformers.min.js"></script>
  
  <script>
    const logEl = document.getElementById('log');
    const resultEl = document.getElementById('result');
    
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Add timeout to detect if transformers.js failed to load
    setTimeout(() => {
      if (typeof transformers === 'undefined') {
        log('ERROR: transformers.js failed to load', 'error');
        window.parent.postMessage({
          type: 'streamlit:setComponentValue',
          value: { error: 'transformers.js library not loaded' }
        }, '*');
      }
    }, 5000);
    
    function displayResult(data) {
      resultEl.textContent = JSON.stringify(data, null, 2);
    }
    
    // Wait for Streamlit to send data
    window.addEventListener('message', async (event) => {
      if (event.data.type !== 'streamlit:render') return;
      
      const config = event.data.args.config;
      
      if (!config) {
        log('No configuration received', 'error');
        return;
      }
      
      log(`Pipeline: ${config.pipeline_type}`, 'info');
      log(`Model: ${config.model_name}`, 'info');
      
      try {
        // Check if transformers is available
        if (typeof transformers === 'undefined') {
          throw new Error('Transformers.js not loaded');
        }
        
        log('Loading pipeline...', 'progress');
        
        // Create pipeline
        const pipeline = await transformers.pipeline(
          config.pipeline_type,
          config.model_name,
          {
            progress_callback: (progress) => {
              if (progress.status === 'downloading') {
                const percent = ((progress.loaded / progress.total) * 100).toFixed(1);
                log(`Downloading ${progress.file}: ${percent}%`, 'progress');
              } else if (progress.status === 'loading') {
                log(`Loading ${progress.file}...`, 'progress');
              }
            }
          }
        );
        
        log('Pipeline loaded successfully âœ“', 'success');
        
        // Process inputs
        let processedInputs = config.inputs;
        
        // Handle base64 images
        if (typeof processedInputs === 'string' && processedInputs.length > 100) {
          // Likely base64 image
          processedInputs = `data:image/jpeg;base64,${processedInputs}`;
          log('Processing image input...', 'progress');
        }
        
        log('Running inference...', 'progress');
        
        // Run pipeline
        const result = await pipeline(processedInputs, config.config);
        
        log('Inference complete âœ“', 'success');
        displayResult(result);
        
        // Send result back to Streamlit
        window.parent.postMessage({
          type: 'streamlit:setComponentValue',
          value: result
        }, '*');
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error('Pipeline error:', error);
        
        window.parent.postMessage({
          type: 'streamlit:setComponentValue',
          value: { error: error.message }
        }, '*');
      }
    });
    
    // Notify Streamlit component is ready
    window.parent.postMessage({
      type: 'streamlit:componentReady',
      apiVersion: 1
    }, '*');
    
    log('Waiting for pipeline configuration...', 'info');
  </script>
</body>
</html>
